using NUnit.Framework;
using scbot.email.services;

namespace scbot.email.tests
{
    public class MessageParsingTests
    {
        public static readonly string EscalationMessageText = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html>\r\n<head>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\r\n<style type=\"text/css\">\r\n    table td {\r\n      border-collapse: collapse;\r\n    }\r\n  </style>\r\n</head>\r\n<body style=\"width: 100%!important; margin: 0; padding: 0;\">\r\n<div style=\"padding: 10px ; line-height: 18px; font-family: 'Lucida Grande',Verdana,Arial,sans-serif; font-size: 12px; color:#444444;\">\r\n<div style=\"color: #b5b5b5;\">##- Please type your reply above this line -##</div>\r\n<p>Rob Clenshaw would like some help with a ticket.<br>\r\nThe Customer account priority is set to: Normal</p>\r\n<p>Please respond with one of these: <a href=\"http://wiki/Support_Escalation_Responses\" rel=\"noreferrer\">\r\nhttp://wiki/Support_Escalation_Responses</a> within a day or so.</p>\r\n<p></p>\r\n<div style=\"margin-top: 25px\" data-version=\"2\">\r\n<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\r\n<tbody>\r\n<tr>\r\n<td width=\"100%\" style=\"padding: 15px 0; border-top: 1px dotted #c5c5c5;\">\r\n<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\" table-layout:fixed;\">\r\n<tbody>\r\n<tr>\r\n<td width=\"100%\" style=\"padding: 0; margin: 0;\" valign=\"top\">\r\n<p style=\"font-family: 'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Verdana,Tahoma,sans-serif; font-size: 15px; line-height: 18px; margin-bottom: 0; margin-top: 0; padding: 0; color:#1b1d1e;\">\r\n<strong>Rob Clenshaw</strong> <span class=\"directional_text_wrapper\">(Support)</span>\r\n</p>\r\n<p style=\"font-family: 'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Verdana,Tahoma,sans-serif; font-size: 13px; line-height: 25px; margin-bottom: 15px; margin-top: 0; padding: 0; color:#bbbbbb;\">\r\nMay 28, 14:57 </p>\r\n<table cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\r\n<tbody>\r\n<tr>\r\n<td style=\"background:#FFF691; padding:5px 11px 6px 10px; color:#333333;\"><strong>Private note</strong>\r\n</td>\r\n</tr>\r\n</tbody>\r\n</table>\r\n<p style=\"color:#2b2e2f; font-size: 14px; line-height: 22px; margin: 15px 0 15px 0; font-family: 'Lucida Sans Unicode', 'Lucida Grande', 'Tahoma', Verdana, sans-serif;\">\r\nHe's not happy :(</p>\r\n<p style=\"color:#2b2e2f; font-size: 14px; line-height: 22px; margin: 15px 0 15px 0; font-family: 'Lucida Sans Unicode', 'Lucida Grande', 'Tahoma', Verdana, sans-serif;\">\r\nIs there anything we can do?</p>\r\n<p></p>\r\n</td>\r\n</tr>\r\n</tbody>\r\n</table>\r\n</td>\r\n</tr>\r\n</tbody>\r\n</table>\r\n</div>\r\n<div style=\"color: #aaaaaa; margin: 10px 0 14px 0; padding-top: 10px; border-top: 1px solid #eeeeee;\">\r\n<!-- agent footer -->\r\n<p style=\"line-height: 19px; font-family: 'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Verdana,Tahoma,sans-serif; margin-bottom: 15px; font-size: 12px; color:#555555;\">\r\nYou are an agent. Add a comment by replying to this email or <strong><a href=\"https://redgatesupport.zendesk.com/agent/tickets/41572\" target=\"_new\">view ticket in Zendesk</a></strong>.\r\n</p>\r\n<table cellpadding=\"1\" cellspacing=\"0\" border=\"0\">\r\n<tbody>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Ticket #</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n41572</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Status</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nOn-hold</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Requester</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nA Customer <acustomer@gmail.com></td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>CCs</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n-</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Group</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nSQL</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Assignee</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nRob Clenshaw</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Priority</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nNormal</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Type</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nIncident</td>\r\n</tr>\r\n<tr>\r\n<td style=\"vertical-align:top; font-size:12px; color:#333333; line-height:18px; text-align:right; padding-right:10px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\n<strong>Channel</strong></td>\r\n<td style=\"vertical-align:top; font-size:12px; color:#777; line-height:18px; font-family:'Lucida Grande','Lucida Sans Unicode','Tahoma',Verdana,sans-serif;\" valign=\"top\">\r\nBy mail</td>\r\n</tr>\r\n</tbody>\r\n</table>\r\n<p>&nbsp;</p>\r\nThis email is a service from Support. Delivered by <a href=\"http://www.zendesk.com\" style=\"color:black\" target=\"_new\">\r\nZendesk</a>. </div>\r\n</div>\r\n<span style=\"color:#FFFFFF\">Message-Id:NJGVB39A_55671ee12ddf9_a3103fe9d48cd3382809a3_sprut</span><span style=\"color:#FFFFFF\">Ticket-Id:41572</span><span style=\"color:#FFFFFF\">Account-Subdomain:redgatesupport</span>\r\n<div itemscope=\"\" itemtype=\"http://schema.org/EmailMessage\" style=\"display:none\">\r\n<div itemprop=\"action\" itemscope=\"\" itemtype=\"http://schema.org/ViewAction\"><link itemprop=\"url\" href=\"https://redgatesupport.zendesk.com/agent/tickets/41572\">\r\n<meta itemprop=\"name\" content=\"View\">\r\n</div>\r\n</div>\r\n</body>\r\n</html>\r\n";

        [Test]
        public void CanParseZendeskEscalation()
        {
            Assert.True(EmailParser.IsZendeskEscalation(EscalationMessageText));
        }

        [Test]
        public void FailsToParsePlainText()
        {
            var messageText = "asdf";
            Assert.False(EmailParser.IsZendeskEscalation(messageText));
        }

        [Test]
        public void CanExtractZendeskLink()
        {
            var escalation = EmailParser.TryGetZendeskEscalation(EscalationMessageText);
            Assert.AreEqual("https://redgatesupport.zendesk.com/agent/tickets/41572", escalation.Url);
            Assert.AreEqual("ZD#41572", escalation.Id);
        }

        [Test]
        public void CanGetSummaryOfEmail()
        {
            var result = EmailParser.GetSlackFormattedSummary(EscalationMessageText);
            System.Console.WriteLine(result);
            Assert.AreEqual("*Rob Clenshaw* (Support)\nMay 28, 14:57 \nHe's not happy :(\nIs there anything we can do?\n*Ticket #* 41572 \n*Status* On-hold \n*Requester* A Customer  \n*CCs* - \n*Group* SQL \n*Assignee* Rob Clenshaw \n*Priority* Normal \n*Type* Incident \n*Channel* By mail \n&nbsp;\n<http://www.zendesk.com|Zendesk>. Message-Id:NJGVB39A_55671ee12ddf9_a3103fe9d48cd3382809a3_sprutTicket-Id:41572Account-Subdomain:redgatesupport", result);
        }
    }
}
